<script>
const SHEET_ID = "1_A9bJiSV_-jsum3QLFX1UE0wkbxukvG9IORSwK1Agiw";
const DASHBOARD_GID = "1134492562"; // Dash Board tab GID
const PCHC_GID = "0"; // PC & HCs tab GID
const NAME_RANGE = "PC & HCs!B2:B22";
const ROWS_PER_PAGE = 10;
const REFRESH_INTERVAL = 60000;

let cols = [], rows = [], filteredRows = [], currentPage = 1, sortCol = null, sortAsc = true;
let dropdownReady = false, sheetReady = false;
let selectedName = "";

function normalizeName(name) {
  return (name || "").toString().trim().toLowerCase();
}

async function fetchDropdown() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?range=${encodeURIComponent(NAME_RANGE)}&tqx=out:json&gid=${PCHC_GID}`;
  try {
    const res = await fetch(url + "&t=" + Date.now());
    const text = await res.text();
    const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
    let values = json.table.rows.map(r => r.c[0] ? (r.c[0].f || r.c[0].v) : "").filter(Boolean);
    values = [...new Set(values)];
    const select = document.getElementById('nameFilter');
    select.innerHTML = '<option value="">Select Employee</option>';
    values.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
    dropdownReady = true;
  } catch (e) {
    document.getElementById('tableWrap').innerText = 'Error loading dropdown!';
    dropdownReady = false;
  }
}

async function fetchSheet() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${DASHBOARD_GID}`;
  try {
    const res = await fetch(url + "&t=" + Date.now());
    const text = await res.text();
    const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
    cols = json.table.cols.map(c => c.label || "");
    rows = json.table.rows.map(r => r.c.map(cell => {
      if (!cell) return "";
      return cell.f !== undefined ? cell.f : (cell.v !== undefined ? cell.v : "");
    }));
    sheetReady = true;
  } catch (e) {
    document.getElementById('tableWrap').innerText = 'Error loading dashboard!';
    sheetReady = false;
  }
}

function applyFilters() {
  if (!dropdownReady || !sheetReady) return;
  selectedName = document.getElementById('nameFilter').value;
  const searchTerm = document.getElementById('searchBox').value.toLowerCase();

  // Find the "Name of the employee" column index (case-insensitive, trims)
  let nameIndex = cols.findIndex(c => normalizeName(c) === "name of the employee");
  if (nameIndex === -1) {
    // fallback: look for column containing "name"
    nameIndex = cols.findIndex(c => normalizeName(c).includes("name"));
    if (nameIndex === -1) {
      document.getElementById('tableWrap').innerText = 'No "Name of the employee" column found in Dash Board tab!';
      document.getElementById('tableWrap').style.display = "block";
      document.getElementById('pagination').style.display = "none";
      return;
    }
  }

  if (!selectedName) {
    document.getElementById('tableWrap').style.display = "none";
    document.getElementById('pagination').style.display = "none";
    document.getElementById('searchBox').disabled = true;
    return;
  }

  const normalizedSelected = normalizeName(selectedName);
  filteredRows = rows.filter(r => {
    const matchesName = normalizeName(r[nameIndex]) === normalizedSelected;
    const matchesSearch = !searchTerm || r.join(" ").toLowerCase().includes(searchTerm);
    return matchesName && matchesSearch;
  });

  document.getElementById('tableWrap').style.display = "block";
  document.getElementById('pagination').style.display = "flex";
  document.getElementById('searchBox').disabled = false;
  currentPage = 1;
  renderTable();
  renderPagination();
}

// ... rest of your code unchanged ...
</script>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Task Duties Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    .container { max-width: 1100px; margin: auto; padding: 20px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 10px; }
    h1 { text-align: center; color: #333; margin-bottom: 15px; }
    .info-row { display: flex; gap: 20px; align-items: center; margin-bottom: 18px; }
    .info-label { font-weight: bold; margin-right: 6px; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; align-items: center; }
    select, .search { padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
    .search { flex: 1; min-width: 200px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #4CAF50; color: white; cursor: pointer; position: sticky; top: 0; }
    tr:nth-child(even) { background: #f2f2f2; }
    .pagination { margin-top: 15px; display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
    .pagination button { padding: 6px 12px; border: none; background: #4CAF50; color: white; cursor: pointer; border-radius: 5px; }
    .pagination button.disabled { background: #ccc; cursor: not-allowed; }
    .pagination button.active { background: #388E3C; }
    #tableWrap { display: none; }
    #pagination { display: none; }
    @media (max-width: 700px) {
      .container { padding: 2px; }
      table { font-size: 12px; }
      th, td { padding: 5px; }
      .info-row { flex-direction: column; gap: 6px; align-items: flex-start; }
      .controls { flex-direction: column; gap: 6px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Task Duties Dashboard</h1>
    <div class="info-row">
      <span class="info-label">Name of Employee (A3):</span>
      <span id="employeeNameA3"></span>
      <span class="info-label">Select Employee (A4):</span>
      <select id="employeeDropdownA4">
        <option value="">Select Employee</option>
      </select>
    </div>
    <div class="controls">
      <span class="info-label">Search in Dashboard:</span>
      <input id="searchBox" class="search" placeholder="Search..." disabled>
    </div>
    <div id="tableWrap">Loading data...</div>
    <div class="pagination" id="pagination"></div>
    <p style="text-align:center;font-size:12px;color:#777;">Auto-refreshes every 60 seconds</p>
  </div>
  <script>
    // Spreadsheet and tab info (Sheet Name: gid)
    const SHEET_ID = "1_A9bJiSV_-jsum3QLFX1UE0wkbxukvG9IORSwK1Agiw";
    const SHEETS = {
      "Dashboard":      { name: "Dashboard", gid: "1134492562" },
      "PC_HCs":         { name: "PC & HCs",  gid: "0" },
      "Tappal":         { name: "Tappal",    gid: "1817585752" },
      "SIs":            { name: "SIs",       gid: "701335861" }
    };

    // Ranges
    const DASHBOARD_A3_RANGE = "A3:A3";                       // Dashboard!A3
    const PC_HCs_NAME_RANGE = "B2:B22";                       // PC & HCs!B2:B22

    const ROWS_PER_PAGE = 10;
    const REFRESH_INTERVAL = 60000;

    // Only allow these names in dropdown:
    const allowedNames = [
      "Syed Naseeruddin Peer","B.Venu Gopal","R. Priya Kumar","K.V. Ranga Reddy","S. Abdul Alam","M. Eswaraiah",
      "P. Jacob Prabhakar","P.Nagendra Babu","V. Madhu Sudhan","M.G. Dhanunjaya","S.A.M. Shafi","T.Prabhakar Rao",
      "K. Giddaiah","C. Praveen","G. Rambabu","P. Madhu Sudhan","K.M. Adithya Prathap","G.Suhasini"
    ];

    let cols = [], rows = [], filteredRows = [], currentPage = 1, sortCol = null, sortAsc = true;

    // Fetch Dashboard!A3 (employee name)
    async function fetchEmployeeNameA3() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?range=${DASHBOARD_A3_RANGE}&tqx=out:json&gid=${SHEETS.Dashboard.gid}`;
      const res = await fetch(url + "&t=" + Date.now());
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const name = (json.table.rows[0] && json.table.rows[0].c[0]) ? (json.table.rows[0].c[0].f || json.table.rows[0].c[0].v) : "";
      document.getElementById('employeeNameA3').textContent = name || "(not set)";
    }

    // Fetch PC & HCs!B2:B22 for dropdown (Dashboard!A4)
    async function fetchEmployeeDropdownA4() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?range=${PC_HCs_NAME_RANGE}&tqx=out:json&gid=${SHEETS.PC_HCs.gid}`;
      const res = await fetch(url + "&t=" + Date.now());
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      let values = json.table.rows.map(r => r.c[0] ? (r.c[0].f || r.c[0].v) : "").filter(Boolean);
      // Only allow names that match provided allowedNames (case and whitespace insensitive)
      values = values.filter(val =>
        allowedNames.some(name => name.trim().toLowerCase() === val.trim().toLowerCase())
      );
      // Remove duplicates and trim spaces
      values = [...new Set(values.map(v => v.trim()))];
      const select = document.getElementById('employeeDropdownA4');
      select.innerHTML = '<option value="">Select Employee</option>';
      values.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    }

    // Fetch all Dashboard tab data for table
    async function fetchDashboardData() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEETS.Dashboard.gid}`;
      const res = await fetch(url + "&t=" + Date.now());
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      cols = json.table.cols.map(c => c.label || "");
      rows = json.table.rows.map(r => r.c.map(cell => cell ? (cell.f ? cell.f : cell.v) : ""));
    }

    function applyFilters() {
      const selectedName = document.getElementById('employeeDropdownA4').value.trim();
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();
      const nameIndex = cols.findIndex(c => c.toLowerCase().includes("name"));

      if (!selectedName) {
        document.getElementById('tableWrap').style.display = "none";
        document.getElementById('pagination').style.display = "none";
        document.getElementById('searchBox').disabled = true;
        return;
      }

      filteredRows = rows.filter(r => {
        const matchesName = r[nameIndex] && r[nameIndex].trim().toLowerCase() === selectedName.toLowerCase();
        const matchesSearch = !searchTerm || r.join(" ").toLowerCase().includes(searchTerm);
        return matchesName && matchesSearch;
      });

      document.getElementById('tableWrap').style.display = "block";
      document.getElementById('pagination').style.display = "flex";
      document.getElementById('searchBox').disabled = false;

      currentPage = 1;
      renderTable();
      renderPagination();
    }

    function renderTable() {
      const tableWrap = document.getElementById('tableWrap');
      const start = (currentPage - 1) * ROWS_PER_PAGE;
      const end = start + ROWS_PER_PAGE;
      const pageRows = filteredRows.slice(start, end);

      const table = document.createElement('table');
      const thead = table.createTHead();
      const headRow = thead.insertRow();
      cols.forEach((col, index) => {
        const th = document.createElement('th');
        th.textContent = col;
        th.onclick = () => sortTable(index);
        if (sortCol === index) th.textContent += sortAsc ? " ▲" : " ▼";
        headRow.appendChild(th);
      });

      const tbody = table.createTBody();
      pageRows.forEach(row => {
        const tr = tbody.insertRow();
        row.forEach(cell => {
          const td = tr.insertCell();
          td.textContent = cell;
        });
      });

      tableWrap.innerHTML = "";
      tableWrap.appendChild(table);
    }

    function renderPagination() {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = "";
      const totalPages = Math.ceil(filteredRows.length / ROWS_PER_PAGE);

      const prevBtn = document.createElement('button');
      prevBtn.textContent = "Prev";
      prevBtn.disabled = currentPage === 1;
      prevBtn.className = prevBtn.disabled ? "disabled" : "";
      prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); renderPagination(); } };
      pagination.appendChild(prevBtn);

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.className = "active";
        btn.onclick = () => { currentPage = i; renderTable(); renderPagination(); };
        pagination.appendChild(btn);
      }

      const nextBtn = document.createElement('button');
      nextBtn.textContent = "Next";
      nextBtn.disabled = currentPage === totalPages || totalPages === 0;
      nextBtn.className = nextBtn.disabled ? "disabled" : "";
      nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; renderTable(); renderPagination(); } };
      pagination.appendChild(nextBtn);
    }

    function sortTable(colIndex) {
      sortAsc = (sortCol === colIndex) ? !sortAsc : true;
      sortCol = colIndex;
      filteredRows.sort((a, b) => {
        if (a[colIndex] < b[colIndex]) return sortAsc ? -1 : 1;
        if (a[colIndex] > b[colIndex]) return sortAsc ? 1 : -1;
        return 0;
      });
      currentPage = 1;
      renderTable();
      renderPagination();
    }

    document.getElementById('searchBox').addEventListener('input', applyFilters);
    document.getElementById('employeeDropdownA4').addEventListener('change', applyFilters);

    async function init() {
      await fetchEmployeeNameA3();
      await fetchEmployeeDropdownA4();
      await fetchDashboardData();
    }

    init();
    setInterval(init, REFRESH_INTERVAL);
  </script>
</body>
</html>
